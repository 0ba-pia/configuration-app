<html>
<head>
	<title>RYME - Keyboard Configuration</title>
	<meta name="robots" content="noindex">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-873168-3', 'auto');
      ga('send', 'pageview');
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
#velocity-canvas {
	border:1px solid #000000
}
button, input, optgroup, select, textarea {
    margin: 1px;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
}
</style>

</head>
<body>

<div class="container">

<div id="alert" class="alert alert-success alert-dismissible hidden" role="alert">
  <span id="message"></span>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

  <div class="row">
    <div class="col">
      	<h2>Keyboard Status</h2>

		<div id="device">
			Device connected : <span id="device-name"></span> <br>
			Model : <span id="model-name"></span> <br>
			Firmware version : <span id="firmware"></span><br>
			MIDI Event : <span id="midiEvent"></span> <span id="midiValue"></span> <span id="midiValue1"></span>
		</div>
		<hr>
		<h2>Configuration</h2>
    </div>
  </div>


    <div class="row">
    	<div class="col-lg-6 col-sm-12">
 		<form id="form">
 
			<b>
			MIDI Channel
			</b>
			<div>
				Current MIDI channel :
				<select id="channel" disabled>
				  <option value="0">1</option>
				  <option value="1">2</option>
				  <option value="2">3</option>
				  <option value="3">4</option>
				  <option value="4">5</option>
				  <option value="5">6</option>
				  <option value="6">7</option>
				  <option value="7">8</option>
				  <option value="8">9</option>
				  <option value="9">10</option>
				  <option value="10">11</option>
				  <option value="11">12</option>
				  <option value="12">13</option>
				  <option value="13">14</option>
				  <option value="14">15</option>
				  <option value="15">16</option>
				</select>
			</div>

		<b>
		Sustain Pedal
		</b>
		<div>
			ON MIDI value is
			<select id="sustain" disabled>
			  <option value="0">0</option>
			  <option value="1">127</option>
			</select>
		</div>

  <div class="section" id="octaves" hidden>


		<b>
		Octave shift
		</b>
		<div>
			Number of octaves
			<select id="octave" disabled>
			  <option value="0">-3</option>
			  <option value="1">-2</option>
			  <option value="1">-1</option>
			  <option value="1">0</option>
			  <option value="1">+1</option>
			  <option value="1">+2</option>
			  <option value="1">+3</option>
			</select>
		</div>



		<b>
		Transpose
		</b>
		<div>
			Number of semitones
			<select id="transpose" disabled>
			  <option value="0">-12</option>
			  <option value="1">-11</option>
			  <option value="2">-10</option>
			  <option value="3">-9</option>
			  <option value="4">-8</option>
			  <option value="5">-7</option>
			  <option value="6">-6</option>
			  <option value="7">-5</option>
			  <option value="8">-4</option>
			  <option value="9">-3</option>
			  <option value="10">-2</option>
			  <option value="11">-1</option>
			  <option value="12">0</option>
			  <option value="13">+1</option>
			  <option value="14">+2</option>
			  <option value="15">+3</option>
			  <option value="16">+4</option>
			  <option value="17">+5</option>
			  <option value="18">+6</option>
			  <option value="19">+7</option>
			  <option value="20">+8</option>
			  <option value="21">+9</option>
			  <option value="22">+10</option>
			  <option value="23">+11</option>
			  <option value="24">+12</option>
			</select>
		</div>

  </div>

  <div class="section" id="controlpanel" hidden>
  
  			<div id="joystick" hidden>
			<b>
			Joystick
			</b>

				<div id="joystick_vry">
					Horizontal
					<select id="knobmode" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Control Change</option>
					  <option value='2'>Pitch Bend</option>
					  <option value="3">Aftertouch</option>
					</select>
					<span id="cc-number">Control Number</span>
					<input id="knobcontrol" type="text" maxlength="3" size="3">
				</div>

				<div id="joystick_vrx">
					Vertical
					<select id="knobmode" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Control Change</option>
					  <option value='2'>Pitch Bend</option>
					  <option value="3">Aftertouch</option>
					</select>
					<span id="cc-number">Control Number</span>
					<input id="knobcontrol" type="text" maxlength="3" size="3">
				</div>
			</div>

		    <b>
			Knobs
			</b>

				<div id="knob0">
					Left
					<select id="knobmode" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Control Change</option>
					  <option value="3">Aftertouch</option>
					</select>
					<span id="cc-number">Control Number</span>
					<input id="knobcontrol" type="text" maxlength="3" size="3">
				</div>

				<div id="knob1">
					Right
					<select id="knobmode" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Control Change</option>
					  <option value="3">Aftertouch</option>
					</select>
					<span id="cc-number">Control Number</span>
					<input id="knobcontrol" type="text" maxlength="3" size="3">
				</div>

		    <b>
			Switches
			</b>

				<div>
					Top left
					<select id="butmode1" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Program shift</option>
					  <option value="2">Octave shift</option>
					  <option value="3">Program select</option>
					  <option value="4">Transpose</option>
					</select>
					Control number :
					<input id="butcontrol1" type="text" maxlength="3" size="3" disabled>
				</div>

				<div>
					Lower left
					<select id="butmode0" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Program shift</option>
					  <option value="2">Octave shift</option>
					  <option value="3">Program select</option>
					  <option value="4">Transpose</option>
					</select>
					Control number :
					<input id="butcontrol0" type="text" maxlength="3" size="3" disabled>
				</div>

				<div>
					Top right
					<select id="butmode3" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Program shift</option>
					  <option value="2">Octave shift</option>
					  <option value="3">Program select</option>
					  <option value="4">Transpose</option>
					</select>
					Control number :
					<input id="butcontrol3" type="text" maxlength="3" size="3" disabled>
				</div>

				<div>
					Lower right
					<select id="butmode2" disabled>
					  <option value="0">Unassigned</option>
					  <option value="1">Program shift</option>
					  <option value="2">Octave shift</option>
					  <option value="3">Program select</option>
					  <option value="4">Transpose</option>
					</select>
					Control number :
					<input id="butcontrol2" type="text" maxlength="3" size="3" disabled>
				</div>
				<div id="Advanced_div" hidden>
					<b>
					Advanced
					</b>
					<div id="EEPROM_USB_SERIAL_div" hidden>
						<input type="checkbox" id="EEPROM_USB_SERIAL">
			  			<label for="enabled"> USB Serial enabled</label><br>
		  			</div>
		  			<div id="EEPROM_DISABLE_SOUNDBOARD_div" hidden>
						<input type="checkbox" id="EEPROM_DISABLE_SOUNDBOARD">
			  			<label for="enabled"> Turn Soundboard OFF</label><br>
		  			</div>
			  	</div>
			  	
				
			</div>
		</div>

	    <div class="col-lg-6 col-sm-12">
			<b>
			Velocity Curve
			</b>
			<br>
			Current configuration<br>
			<canvas id="velocity-canvas" width="128" height="128"></canvas>
			<br>
			<div id="velocity">
			Click and drag to draw a custom curve or select a preset below<br>
			  <button type="button" id="vel1">1 - Linear</button><br>
			  <button type="button" id="vel2">2 - Compressed</button><br>
			  <button type="button" id="vel3">3 - Medium</button><br>
			  <button type="button" id="vel4">4 - Compressor/Expander</button><br>
			  <button type="button" id="vel5">5 - Low velocity 1</button><br>
			  <button type="button" id="vel6">6 - Low velocity 2 (default)</button><br>
			  <button type="button" id="vel7">7 - Compressed top and bottom</button><br>
			  <button type="button" id="vel8">8 - Full velocity</button>
			</div>
			<div id="EEPROM_RELEASE_VELOCITY_div" >
				<input type="checkbox" id="EEPROM_RELEASE_VELOCITY">
	  			<label for="enabled"> Release velocity enabled</label><br>
  			</div>
			<br>
	  	</div>
	</div>

	<div class="row">
		<div class="col">
			<input id="reset" type="submit" class="btn btn-primary" value="Load default values" disabled>
			<input id="load" type="submit" class="btn btn-primary" value="Load from keyboard" disabled>
			<input id="update" type="submit" class="btn btn-warning" value="Send to keyboard" disabled>
		</div>
	</div>
	
	<hr>
	
	<div class="row" id="midirecorder" hidden>
		<div class="col">
			<h2>Recording</h2>
			<input id="writeBuffer" type="submit" class="btn btn-primary" value="Save current session" disabled>
			<input id="saveMidiFile" type="submit" class="btn btn-primary" value="Download last session" disabled>
		</div>
  	</div>
			  
    <div class="row" id="expert" hidden>
        <div class="col">
                <hr>
            <h2>Expert</h2>
            <input id="reboot" type="submit" class="btn btn-primary" value="Reboot keyboard" disabled>
            <input id="selfTest" type="submit" class="btn btn-primary" value="Self Test keyboard" disabled>
            <input id="deleteAllMidiFiles" type="submit" class="btn btn-danger" value="Delete all saved sessions" disabled>
        </div>
    </div>	
	
</form>

<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


<script>
$(function() {

const EEPROM_SUSTAIN = 0;
const EEPROM_VELOCITY = 1;
const EEPROM_MIDI_CHANNEL = 22;
const EEPROM_TRANSPOSE = 23;
const EEPROM_OCTAVE = 24;
const EEPROM_PEDAL_TYPE = 25;
const EEPROM_KNOBMODE0 = 26;
const EEPROM_KNOBCTRL0 = 27;
const EEPROM_KNOBMODE1 = 28;
const EEPROM_KNOBCTRL1 = 29;
const EEPROM_BTNMODE0 = 30;
const EEPROM_BTNCTRL0 = 31;
const EEPROM_BTNMODE1 = 32;
const EEPROM_BTNCTRL1 = 33;
const EEPROM_BTNMODE2 = 34;
const EEPROM_BTNCTRL2 = 35;
const EEPROM_BTNMODE3 = 36;
const EEPROM_BTNCTRL3 = 37;
const EEPROM_RELEASE_VELOCITY = 38;
const EEPROM_USB_SERIAL = 39;
const EEPROM_DISABLE_SOUNDBOARD = 40;
const EEPROM_JOYSTICK_VRX_MODE = 41;
const EEPROM_JOYSTICK_VRX_CTRL = 42;
const EEPROM_JOYSTICK_VRY_MODE = 43;
const EEPROM_JOYSTICK_VRY_CTRL = 44;
const EEPROM_SERIAL = 125;
const EEPROM_FIRMWARE = 126;
const EEPROM_DUMP_MIDIFILE = 124;
const EEPROM_SAVE_MIDIBUFFER  = 123;
const EEPROM_DELETE_MIDIFILES = 122;

const MANUFACTURER_MIDI_ID = 0x20;
const NOTE_ON = 0x90;
const NOTE_OFF = 0x80;
const CC = 0xb0;
const PITCHBEND = 0xe0;
const AFTERTOUCH = 0xd0;
const SUSTAIN = 0x40;
const ACTION_READ = 0x11;
const ACTION_WRITE = 0x12;
const ACTION_EXECUTE = 0x13;

var selfTestNoteOn = false;
var pianoDeVoyage;
let searchParams = new URLSearchParams(window.location.search);
var velCurveConfig = [];
var velCurves = [
	{name:"1 - Linear", points : [[0,127], [127,0], [127,0], [127,0], [127,0],[127,0], [127,0], [127,0], [127,0], [127,0]]},
	{name:"2 - Compressed", points : [[0,127],[24, 118], [52, 101], [102, 42], [127,0], [127,0],[127,0], [127,0], [127,0], [127,0]]},
	{name:"3 - Medium", points : [[0,127],[11, 98],[27, 74],[62, 65],[97, 57],[116, 21],[121, 5],[127,0], [127,0], [127,0],]},
	{name:"4 - Compressor/Expander", points : [[0,127],[1, 114],[12, 104],[100, 94],[116, 55],[122, 5], [127,0], [127,0], [127,0], [127,0]]},
	{name:"5 - Low velocity 1", points : [[0,127],[6, 120],[30, 120],[53, 112],[81, 89],[102, 59],[113, 30],[119, 5], [127,0], [127,0]]},
	{name:"6 - Low velocity 2", points : [[0,127],[9, 116],[45, 116],[62, 110],[83, 95],[100, 73],[113, 44],[120, 6], [127,0], [127,0]]},
	{name:"7 - Compressed top and bottom", points : [[0,127],[5, 104],[47, 94],[77, 82],[99, 66],[115, 45],[120, 34],[122, 5], [127,0], [127,0]]},
	{name:"8 - Full velocity", points : [[0,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0]]}
	];
var midiFileBuffer = [];

function onMIDISuccess( midiAccess ) {
	console.log( "MIDI ready!" );
	midiAccess.addEventListener('statechange', function(event) {
	  listInputsAndOutputs(midiAccess);
	});
	listInputsAndOutputs( midiAccess );
}

function onMIDIFailure(msg) {
  console.log( "Failed to get MIDI access - " + msg );
  document.getElementById("message").innerHTML =
	  "Sorry, Web MIDI is not supported by your browser, please use Chrome or install the <a href='https://jazz-soft.net/download/web-midi/'>WebMIDI plugin</a>";
  $('#alert').show();
}

if (navigator.requestMIDIAccess) {
	$('#alert').alert('close');
	navigator.requestMIDIAccess( { sysex: true } ).then( onMIDISuccess, onMIDIFailure );
} else {
	onMIDIFailure("");
}

function listInputsAndOutputs( midiAccess ) {
	pianoDeVoyage = null;

	// outputs
	var iter = midiAccess.outputs.values();
    for (var o = iter.next(); !o.done; o = iter.next()) {
    	var output = o.value;
		if ((output.name.startsWith("Piano de Voyage")) || (output.manufacturer.startsWith("Ryme Music"))) {
			if (output.connection === "open") {
				// inputs
				var inputs = midiAccess.inputs.values();
    			for (var inp = inputs.next(); !inp.done; inp = inputs.next()) {
    			var input = inp.value;
					if (input.name.startsWith("Piano de Voyage")) {
						if (input.connection === "open") {
							pianoDeVoyage = output;
							input.onmidimessage = onMIDIMessage;
							console.log( "Output port [type:'" + output.type + "'] id:'" + output.id +
								      "' manufacturer:'" + output.manufacturer + "' name:'" + output.name +
								      "' version:'" + output.version + "'" );
							document.getElementById("device-name").innerHTML = "<span class='text-success'>"+output.name+"</span>";
							
							// add event listeners
							var vel = document.getElementById("velocity");
							var items = vel.querySelectorAll("button");
							items.forEach(function(item) {
								  item.addEventListener("click", onSelectVelocity);
								});
							var form = document.getElementById("form");
							for (var i = 0; i < form.length; i++) {
								form[i].removeAttribute("disabled");
							}

							document.getElementById("knob0").querySelector("#knobmode").addEventListener('change', onChangeKnobMode);
							document.getElementById("knob1").querySelector("#knobmode").addEventListener('change', onChangeKnobMode);
							
							document.getElementById("joystick_vrx").querySelector("#knobmode").addEventListener('change', onChangeKnobMode);
							document.getElementById("joystick_vry").querySelector("#knobmode").addEventListener('change', onChangeKnobMode);

							loadFromKeyboard();
							
							document.getElementById("reset").addEventListener("click", onResetDefaults);
							document.getElementById("update").addEventListener("click", onSubmit);
							document.getElementById("load").addEventListener("click", onLoadFromKeyboard);
							document.getElementById("reboot").addEventListener("click", onReboot);
							document.getElementById("selfTest").addEventListener("click", selfTest);
							document.getElementById("writeBuffer").addEventListener("click", writeBuffer);
							document.getElementById("saveMidiFile").addEventListener("click", saveMidiFile);
							document.getElementById("deleteAllMidiFiles").addEventListener("click", deleteAllMidiFiles);
							
						} else {
							// will trigger a state change event
							input.open();
						}
					}
				}
			} else {
				// will trigger a state change event
				output.open();
			}
		}
	}

	if (!pianoDeVoyage) {
		document.getElementById("device-name").innerHTML = "<span class='text-warning'>Please connect a compatible device</span>";
	}
}

function onChangeKnobMode( event ) {
	let mode = event.target.value;
	let sel = event.target;
	let knob = event.target.parentNode;
	switch(mode) {
		case "0" :
			// unassigned
			knob.querySelector("#cc-number").innerHTML = ""
			knob.querySelector("#knobcontrol").setAttribute("hidden", true);
			break;
		case "1" :
			// cc
			knob.querySelector("#cc-number").innerHTML = "Control Number:"
			knob.querySelector("#knobcontrol").removeAttribute("hidden");
			break;
		case "2" :
			// pitch bend
			knob.querySelector("#cc-number").innerHTML = "Sensitivity:"
			knob.querySelector("#knobcontrol").removeAttribute("hidden");
			break;
		case "3" :
			// aftertouch
			knob.querySelector("#cc-number").innerHTML = ""
			knob.querySelector("#knobcontrol").setAttribute("hidden", true);
			break;
			
	}
}

function onResetDefaults( event ) {
	let select;
	event.preventDefault();
	selectVelocity(5);
	document.getElementById("sustain").selectedIndex = 1;
	document.getElementById("channel").selectedIndex = 0;
	document.getElementById("octave").selectedIndex = 3;
	document.getElementById("transpose").selectedIndex = 12;
	document.getElementById("EEPROM_RELEASE_VELOCITY").checked = 0;
	// knobs
	select = document.getElementById("knob0").querySelector("#knobmode");
	select.selectedIndex = 1;
	select.dispatchEvent(new Event('change'));
	document.getElementById("knob0").querySelector("#knobcontrol").value = 7;
	select = document.getElementById("knob1").querySelector("#knobmode");
	select.selectedIndex = 1;
	document.getElementById("knob1").querySelector("#knobcontrol").value = 91;
	select.dispatchEvent(new Event('change'));
	// joystick
	select = document.getElementById("joystick_vrx").querySelector("#knobmode");
	select.selectedIndex = 0;
	select.dispatchEvent(new Event('change'));
	document.getElementById("joystick_vrx").querySelector("#knobcontrol").value = 0;
	select = document.getElementById("joystick_vry").querySelector("#knobmode");
	select.selectedIndex = 2;
	document.getElementById("joystick_vry").querySelector("#knobcontrol").value = 3;
	select.dispatchEvent(new Event('change'));
	// buttons
	document.getElementById("butmode0").selectedIndex = 2;
	document.getElementById("butcontrol0").value = 1;
	document.getElementById("butmode1").selectedIndex = 1;
	document.getElementById("butcontrol1").value = 1;
	document.getElementById("butmode2").selectedIndex = 2;
	document.getElementById("butcontrol2").value = 0;
	document.getElementById("butmode3").selectedIndex = 1;
	document.getElementById("butcontrol3").value = 0;
	// other
	document.getElementById("EEPROM_USB_SERIAL").checked = 0;
	document.getElementById("EEPROM_DISABLE_SOUNDBOARD").checked = 0;
}

function onReboot( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, ACTION_EXECUTE, 0);
}

function selfTest( event ) {
	event.preventDefault();
	if (selfTestNoteOn) {
		pianoDeVoyage.send([0x80, 60, 0x7f]);
	} else {
		pianoDeVoyage.send([0x90, 60, 0x7f]);
	}
	selfTestNoteOn = !selfTestNoteOn;
}

function writeBuffer( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_SAVE_MIDIBUFFER);
}

function deleteAllMidiFiles( event ) {
    event.preventDefault();
    sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_DELETE_MIDIFILES);
}

function saveMidiFile( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_DUMP_MIDIFILE);
}

function onLoadFromKeyboard( event ) {
	event.preventDefault();
	loadFromKeyboard();
}

function loadFromKeyboard() {
	// read config
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_FIRMWARE);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_SUSTAIN);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_VELOCITY);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_RELEASE_VELOCITY);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_MIDI_CHANNEL);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_TRANSPOSE);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_OCTAVE);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_KNOBMODE0);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_BTNMODE0);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_USB_SERIAL);	
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_DISABLE_SOUNDBOARD);	
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_JOYSTICK_VRX_MODE);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_JOYSTICK_VRY_MODE);
}

function onSubmit( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_SUSTAIN, [document.getElementById("sustain").selectedIndex]);
	// send read cmd to make sure we're good
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_SUSTAIN);

	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_MIDI_CHANNEL, [document.getElementById("channel").selectedIndex]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_MIDI_CHANNEL);

	// velocity
	var values = [];
	for (var i=0; i<velCurveConfig.length; i++) {
		values.push(velCurveConfig[i][0]); // x
		values.push(127-velCurveConfig[i][1]); // y
	}
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_VELOCITY, values);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_VELOCITY);

	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_RELEASE_VELOCITY, [document.getElementById("EEPROM_RELEASE_VELOCITY").checked]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_RELEASE_VELOCITY);

	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_TRANSPOSE, [document.getElementById("transpose").selectedIndex]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_TRANSPOSE);

	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_OCTAVE, [document.getElementById("octave").selectedIndex]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_OCTAVE);

	// knobs
	values = [];
	for (var i=0; i<2; i++) {
		values.push(document.getElementById("knob"+i).querySelector("#knobmode").value);
		values.push(document.getElementById("knob"+i).querySelector("#knobcontrol").value);
	}
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_KNOBMODE0, values);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_KNOBMODE0);
	
	// joystick
	values = [];
	values.push(document.getElementById("joystick_vrx").querySelector("#knobmode").value);
	values.push(document.getElementById("joystick_vrx").querySelector("#knobcontrol").value);
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_JOYSTICK_VRX_MODE, values);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_JOYSTICK_VRX_MODE);
	values = [];
	values.push(document.getElementById("joystick_vry").querySelector("#knobmode").value);
	values.push(document.getElementById("joystick_vry").querySelector("#knobcontrol").value);
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_JOYSTICK_VRY_MODE, values);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_JOYSTICK_VRY_MODE);
	

	// switches
	values = [];
	for (var i=0; i<4; i++) {
		values.push(document.getElementById("butmode"+i).selectedIndex);
		values.push(document.getElementById("butcontrol"+i).value);
	}
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_BTNMODE0, values);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_BTNMODE0);
	
	// usb serial
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_USB_SERIAL, [document.getElementById("EEPROM_USB_SERIAL").checked]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_USB_SERIAL);
	
	// soundboard
	sendSysEx(pianoDeVoyage, ACTION_WRITE, EEPROM_DISABLE_SOUNDBOARD, [document.getElementById("EEPROM_DISABLE_SOUNDBOARD").checked]);
	sendSysEx(pianoDeVoyage, ACTION_READ, EEPROM_DISABLE_SOUNDBOARD);

	alert("Keyboard configuration updated");
}

function onSelectVelocity( event ) {
	var id = parseInt(event.target.id.charAt(3));
	selectVelocity(id-1);
}

function selectVelocity(idx) {
	velCurveConfig = [];
	var points = velCurves[idx].points;
	for (var i=0; i<points.length; i++) {
		velCurveConfig.push(points[i]);
	}
	drawVelocityCurve();
}

function onMIDIMessage( event ) {
	var str = "MIDI message received at timestamp " + event.timestamp + "[" + event.data.length + " bytes]: ";
	for (var i=0; i<event.data.length; i++) {
	  str += "0x" + event.data[i].toString(16) + " ";
	}
	console.log( str );
	var v = event.data[1];
	var midiCmd = event.data[0] & 0xF0;
	switch(midiCmd) {
		case NOTE_ON:
			document.getElementById("midiEvent").innerHTML = "Note On";
			document.getElementById("midiValue").innerHTML = v;
			document.getElementById("midiValue1").innerHTML = "";
			break;
		case NOTE_OFF:
			document.getElementById("midiEvent").innerHTML = "Note Off";
			document.getElementById("midiValue").innerHTML = v;
			document.getElementById("midiValue1").innerHTML = "";
			break;
		case CC:
			document.getElementById("midiEvent").innerHTML = "Control";
			document.getElementById("midiValue").innerHTML = v;
			if (typeof event.data[2] !== 'undefined') {
				document.getElementById("midiValue1").innerHTML = ": "+event.data[2];
			} else {
				document.getElementById("midiValue1").innerHTML = "";
			}
			break;
		case PITCHBEND:
			document.getElementById("midiEvent").innerHTML = "PitchBend";
			document.getElementById("midiValue").innerHTML = "";
			if (typeof event.data[2] !== 'undefined') {
				var v = (event.data[2]*128)+event.data[1];
				document.getElementById("midiValue1").innerHTML = ": "+v;
			} else {
				document.getElementById("midiValue1").innerHTML = "";
			}
			break;
		case AFTERTOUCH:
			document.getElementById("midiEvent").innerHTML = "AfterTouch";
			document.getElementById("midiValue").innerHTML = v;
			if (typeof event.data[2] !== 'undefined') {
				document.getElementById("midiValue1").innerHTML = ": "+event.data[2];
			} else {
				document.getElementById("midiValue1").innerHTML = "";
			}
			break;
	}
	if (event.data[0] == 0xF0) {
		// SYSEX event		
		const SYSEX_START = 0x10;
		const SYSEX_ACTION = 0x42;
		
		if (event.data[2] === SYSEX_START && event.data[3] === SYSEX_ACTION && event.data[4] === ACTION_WRITE) {
			// this is a write event
			v = event.data[6];
			var values = readSysExValues(event.data);
			switch(event.data[5]) {
				case EEPROM_SUSTAIN:
					// update conf 1
					var b = v & 0b00000001;
					document.getElementById("sustain").selectedIndex = b;
					break;
				case EEPROM_MIDI_CHANNEL:
					document.getElementById("channel").selectedIndex = v;
					break;
				case EEPROM_OCTAVE:
					document.getElementById("octave").selectedIndex = v;
					break;
				case EEPROM_TRANSPOSE:
					document.getElementById("transpose").selectedIndex = v;
					break;
				case EEPROM_VELOCITY:
					// update velocity curve
					velCurveConfig = [];
					for (var i=0; i<values.length; i=i+2) {
						velCurveConfig.push([values[i],127-values[i+1]]);
					}
					drawVelocityCurve();
					break;
				case EEPROM_RELEASE_VELOCITY:
					document.getElementById("EEPROM_RELEASE_VELOCITY").checked = v;
					break;
				case EEPROM_FIRMWARE:
					var v0 = String.fromCharCode(values[0]);
					var v1 = parseInt(String.fromCharCode(values[1]));
					var v2 = parseInt(String.fromCharCode(values[2]));
					var v3 = parseInt(String.fromCharCode(values[3]));
					var v4 = parseInt(String.fromCharCode(values[4]));
					var f = v1 + ".";
					f += v2 + ".";
					f += v3 + ".";
					f += v4;
					document.getElementById("firmware").innerHTML = f;
					
					// model name
					var modelName;
					switch(v0) {
						case "v" :
							modelName = "V2DJ24";
							break;
						case "w" :
							modelName = "V2DJ15";
							break;
						case "u" :
							modelName = "V2C24K2";
							break;
						case "s" :
							modelName = "V2C24K1";
							break;
						case "r" :
							modelName = "V2C15K2";
							break;
						case "n" :
							modelName = "V2C15K1";
							break;
						case "o" :
							modelName = "V2A";
							break;
						default :
							modelName = "V2";
					}
					document.getElementById("model-name").innerHTML = modelName;
					
					// expert mode
					var expertMode = searchParams.has('expert');
					if (expertMode) {
						document.getElementById("expert").removeAttribute("hidden");
					}
					
					// display compatible features
					var firmwareVersion = v1*1000+v2*100+v3*10+v4;
					if (firmwareVersion >= 2970) {
							document.getElementById("midirecorder").removeAttribute("hidden");
					} 
					if (firmwareVersion < 2930) {
						for (var i=0; i<4; i++) {
							let butMode = document.getElementById("butmode"+i);
							butMode.remove(4);
						}
					} 
					if (firmwareVersion >= 2910) {
						for (var i=0; i<2; i++) {
							let knobMode = document.getElementById("knob"+i).querySelector("#knobmode");
							var j, L = knobMode.options.length - 1;
						   	for(j = L; j >= 0; j--) {
						    	knobMode.remove(j);
						   	}
							knobMode.insertAdjacentHTML("beforeend","<option value='0'>Unassigned</option>");
							knobMode.insertAdjacentHTML("beforeend","<option value='1'>Control Change</option>");
							knobMode.insertAdjacentHTML("beforeend","<option value='2'>Pitch Bend</option>");
							knobMode.insertAdjacentHTML("beforeend","<option value='3'>Aftertouch</option>");
						}
						if ((v0 === 'v') || (v0 === 'w')){
							document.getElementById("joystick").removeAttribute("hidden");
						}
					} else {
						document.getElementById("Advanced_div").setAttribute("hidden", true);
						document.getElementById("EEPROM_USB_SERIAL_div").setAttribute("hidden", true);
					}
					if (firmwareVersion >= 2850) {
						document.getElementById("Advanced_div").removeAttribute("hidden");
						if (expertMode) { 
							document.getElementById("EEPROM_USB_SERIAL_div").removeAttribute("hidden");
						}	
						if (v0 >= 'r') {
							document.getElementById("EEPROM_DISABLE_SOUNDBOARD_div").removeAttribute("hidden");
						} else {
							document.getElementById("EEPROM_DISABLE_SOUNDBOARD_div").setAttribute("hidden", true);
						}
					} else {
						document.getElementById("Advanced_div").setAttribute("hidden", true);
						document.getElementById("EEPROM_USB_SERIAL_div").setAttribute("hidden", true);
					}
					if (firmwareVersion > 2600) {
						document.getElementById("EEPROM_RELEASE_VELOCITY_div").removeAttribute("hidden");
					} else {
						document.getElementById("EEPROM_RELEASE_VELOCITY_div").setAttribute("hidden", true);
					}
					var panel = document.getElementById("controlpanel");
					if (firmwareVersion > 2300) {
						panel.removeAttribute("hidden");
					} else {
						panel.setAttribute("hidden", true);
					}
					var octaves = document.getElementById("octaves");
					if (v1>1) {
						octaves.removeAttribute("hidden");
					} else {
						octaves.setAttribute("hidden", true);
					}
					break;
				case EEPROM_KNOBMODE0:
					if (values.length > 2) {
						var idx = 0;
						for (var i=0; i<values.length/2; i++) {
							idx = i*2;
							var mode = values[idx];
							var cc = values[idx+1];
							document.getElementById("knob"+i).querySelector("#knobcontrol").value = cc;
							let select = document.getElementById("knob"+i).querySelector("#knobmode");
							select.selectedIndex = mode;
							select.dispatchEvent(new Event('change'));
						}
					}
					break;
				case EEPROM_JOYSTICK_VRX_MODE:
					{
						var mode = values[0];
						var cc = values[1];
						document.getElementById("joystick_vrx").querySelector("#knobcontrol").value = cc;
						let select = document.getElementById("joystick_vrx").querySelector("#knobmode");
						select.selectedIndex = mode;
						select.dispatchEvent(new Event('change'));
						break;
					}
				case EEPROM_JOYSTICK_VRY_MODE:
					{
						var mode = values[0];
						var cc = values[1];
						document.getElementById("joystick_vry").querySelector("#knobcontrol").value = cc;
						let select = document.getElementById("joystick_vry").querySelector("#knobmode");
						select.selectedIndex = mode;
						select.dispatchEvent(new Event('change'));
						break;
					}
				case EEPROM_BTNMODE0:
					if (values.length > 2) {
						var idx = 0;
						for (var i=0; i<values.length/2; i++) {
							idx = i*2;
							var mode = values[idx];
							var cc = values[idx+1];
							document.getElementById("butmode"+i).selectedIndex = mode;
							document.getElementById("butcontrol"+i).value = cc;
						}
					}
					break;
				case EEPROM_USB_SERIAL:
					document.getElementById("EEPROM_USB_SERIAL").checked = v;
					break;
				case EEPROM_DISABLE_SOUNDBOARD:
					document.getElementById("EEPROM_DISABLE_SOUNDBOARD").checked = v;
					break;
				}
			} else {
				// Get the message body (without the Sysex start and end) and decode it
				var sysExBody = event.data.slice(1,event.data.length-1);
				console.log(sysExBody);
				var sysExBodyMsg = decodeSysEx(sysExBody);
				console.log(sysExBodyMsg);
				const SYSEX_MIDI_FILE_HEADER = [0x4D,0x54,0x68,0x64,0x00,0x00,0x00];
				hasMidiFileHeader = true;
				i=0;
				while (hasMidiFileHeader && i<SYSEX_MIDI_FILE_HEADER.length) {
					if (sysExBodyMsg[i] !== SYSEX_MIDI_FILE_HEADER[i]) {
						hasMidiFileHeader = false;
					}
					i++;
				}
				if (hasMidiFileHeader) {
					console.log("hasMidiFileHeader");
					midiFileBuffer = [sysExBodyMsg];
				} else if (midiFileBuffer.length === 0) {
					// unknown sysex message
					console.log("Unknown sysex message");
				} else {
					// continue appending the file buffer
					midiFileBuffer.push(sysExBodyMsg);
				}
				if ((midiFileBuffer.length > 0) && (sysExBodyMsg.length < 112)) {
					// end for midi file
					createMidiFile();
					midiFileBuffer = [];
				}
			}
		}
		
}

function createMidiFile() {
  const blob = new Blob(midiFileBuffer, { type: 'audio/midi' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'voyage.mid';
  link.click();
  URL.revokeObjectURL(url);
}


function readSysExValues(buffer) {
	var v, v2;
	var values = [];
	for (var i=6; i<buffer.length; i++) {
		v = buffer[i];
		v2 = buffer[i+1];
		if (v2 === 0xF7) {
			// END of message
			// verifyChecksum(v);
			break;
		} else {
			values.push(v);
		}
	}
	return values;
}

function sendSysEx( output , action, addr, values) {
	var buffer = [0xF0, MANUFACTURER_MIDI_ID, 0x10, 0x42, action, addr];
	if (values) {
		for (var i=0; i<values.length; i++) {
			buffer.push(values[i]);
		}
	} else {
		buffer.push(0x00);
	}
	buffer.push(0x00);
	buffer.push(0xF7);
	output.send( buffer);
}

function decodeSysEx(inSysEx) {
    msbStorage = 0;
    byteIndex  = 0;
    outData = [];

    for (i=0; i<=inSysEx.length; i++) {
        if (i % 8 == 0) {
            msbStorage = inSysEx[i];
            byteIndex = 6;
        } else {
            body = inSysEx[i];
            msb = ((msbStorage >> byteIndex) & 1) << 7;
            byteIndex -= 1;
            outData.push(msb | body);
         }  
    }
    output = new Uint8Array(outData);
    return output;
}

function drawVelocityCurve() {
	var canvas = document.getElementById("velocity-canvas");
	var ctx = canvas.getContext("2d");
	ctx.beginPath();
	ctx.clearRect(0, 0, 128, 128);
	var velCurvePoints = [];
	for (var i=0; i<velCurveConfig.length; i++) {
		velCurvePoints.push(velCurveConfig[i]);
	}

	for (var i=0; i<velCurvePoints.length-1; i++) {
		var p0 = velCurvePoints[i];
		var p1 = velCurvePoints[i+1];
		// point
		ctx.fillStyle = 'rgb(200, 0, 0)';
        ctx.beginPath();
        ctx.arc(p0[0], p0[1], 3, 0, 2 * Math.PI);
        ctx.fill();
        // line
        var xA=p0[0];
        var yA=p0[1];
        var xB=p1[0];
        var yB=p1[1];
        ctx.moveTo(xA, yA);
        ctx.lineTo(xB, yB);
        ctx.stroke();
	}
}

var mousePressed = false;

function initVelocityCanvas() {
    $('#velocity-canvas').mousedown(function (e) {
        mousePressed = true;
        updateVelocityCanvas(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, false);
    });

    $('#velocity-canvas').mousemove(function (e) {
        if (mousePressed) {
        	updateVelocityCanvas(e.pageX - $(this).offset().left, e.pageY - $(this).offset().top, true);
        }
    });

    $('#velocity-canvas').mouseup(function (e) {
        mousePressed = false;
    });
	    $('#velocity-canvas').mouseleave(function (e) {
        mousePressed = false;
    });
}

function updateVelocityCanvas(x, y, isDown) {
    if (isDown) {
    	var bar = Math.round(x/14.2);
    	x =  Math.round((bar)*14.2);
    	if (x>127) {
    		x = 127;
    	}
    	velCurveConfig[bar] = [x, y];
        drawVelocityCurve();
    }
}

initVelocityCanvas();


});

</script>

	<hr>
	
<div style="color : lightgrey;">v1.3.0</div>
 </body>
</html>
